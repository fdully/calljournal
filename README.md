# ТЗ - сервис "Журнал звонков"
[![Build Status](https://travis-ci.com/fdully/calljournal.svg?branch=master)](https://travis-ci.com/fdully/calljournal)

## Общее описание
Сервис предназначен для упорядоченного хранения аудио записей и мета информации о телефонных звонках.
А также для быстрого и удобного поиска аудио записей по номеру телефона и дате через API. 
Данные о звонках и аудио записи поступают из телефонной станции в json и wav форматах.
Пользовательский интерфейс не предусмотрен.

## Описание сущностей
### Звонок
* Данные звонка

### Аудио файл
* Данные аудиофайла


## Архитектура
Клиент/Сервер.
Клиент запущен на телефонном сервере и мониторит дериктории с аудио записями и метаданными по звонкам.
Клиентов может быть несколько, на каждом телефонной системе по одному клиенту. Одна база данных - postgres на сервере.
Хранилищ аудиозаписей может быть несколько. Клиенты вычитывают json файлы и аудио записи на из папки и отправляют
с помощью GRPC на сервер. Если сервер недоступен, клиенты пробуют снова в цикле загрузить данные,
 используется дефолтный GRPC backoff. Сервер после загрузки данных кладет их в очередь NSQ. А аудиозапись сохраняет
 во временное файловое хранилище. Отдельно работает сервис - загрузчик аудиофайлов в постоянное хранилище.
Cервис состоит из API, базы для хранения данных о звонках и хранилищ аудио записей
(можно использовать S3 интерфейс для хранения аудио файлов или складывать в папки самостоятельно).
Сервис должен предоставлять GRPC и REST API.

#### Загрузчик аудиозаписей в постоянное хранилище в формате mp3 (STEREO)
#####TODO
Это отдельный сервис, который подписывается на сообщения из очереди по загрузке аудиофайла.
Далее копирует аудио файл из временного хранилища, конвертирует в mp3 и загружает в постоянное хранилище.

## Описание методов API

#### Добавление данных о звонке в базу
Запрос:
* Звонок

Ответ:
* ok

#### Загрузка аудио записи во временное хранилище
Запрос:
* Аудио файл

Ответ:
* ok

#### Поиск всех звонков по номеру телефона
#####TODO
Запрос:
* Номер телефона

Ответ:
* Список звонков

#### Поиск всех звонков за интервал времени
#####TODO
Запрос:
* Начало и конец временного интервала

Ответ:
* Список звонков

#### Скачивание файла записи
#####TODO
Запрещено скачивать файлы с тегом private

Запрос:
* ID звонка

Ответ:
* Аудио файл


## Конфигурация
Основные параметры конфигурации: хранилище для аудио записей, база данных по звонкам,
директории с json и wav файлами на сервере телефонии.

## Развертывание
Развертывание микросервиса должно осуществляться командой `make run` (внутри `docker compose up`)
в директории с проектом.

## Тестирование
Так же необходимо написать интеграционные тесты, проверяющие все вызовы API.
